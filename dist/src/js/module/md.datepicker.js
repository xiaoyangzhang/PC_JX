/*! pc_jx - v1.0.0 - 2016-07-28 */
define(function(require,exports,module){$public=require("public"),$datepicker=function(){/****************************************************价格日历********************************************/
this.solarMonth=new Array(31,28,31,30,31,30,31,31,30,31,30,31),this.nStr1=new Array("日","一","二","三","四","五","六","七","八","九","十"),this.rangedays=90,this.empty_ckbox={},
//保存y年m+1月的相关信息
this.fat=this.mat=9,
//在表格中显示公历和农历的日期,以及相关节日
this.cld,this.isCtrl=!1,
//用自定义变量保存当前系统中的年月日
this.Today=new Date,this.tY=this.Today.getFullYear(),this.tM=this.Today.getMonth(),this.tD=this.Today.getDate(),this.lunarInfo=new Array(19416,19168,42352,21717,53856,55632,91476,22176,39632,21970,19168,42422,42192,53840,119381,46400,54944,44450,38320,84343,18800,42160,46261,27216,27968,109396,11104,38256,21234,18800,25958,54432,59984,28309,23248,11104,100067,37600,116951,51536,54432,120998,46416,22176,107956,9680,37584,53938,43344,46423,27808,46416,86869,19872,42448,83315,21200,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46496,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19415,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448),this.supplierCalendar={seller_id:$('input[name="sellerId"]').val(),hotel_id:$('input[name="hotelId"]').val(),sku_flag:"",bizSkuInfo:[]},this.init.apply(this,arguments)},$datepicker.prototype={init:function(){var _self=this;$(".rds").val()&&(_self.rangedays=$(".rds").val()),
//设置价和库存
$(".setvl").on("click",function(){var $dtbx=$(".day .choiced .dtbx"),price=$(".price").val(),stock=$(".stock").val();if($dtbx.length>0){if(!/^\d{1,6}(\.\d{1,2})?$|^[1-9]\d{0,5}$/.test($(".price").val()))return $public.dialog.msg("“价格”为数字,最大6位整数,能带两位小数","error"),void $(".price").focus();if(!/^[1-9]\d{0,5}$/.test($(".stock").val()))return $public.dialog.msg("“库存”为数字,最大6位整数","error"),void $(".stock").focus();$dtbx.filter(function(){_self.set_tdvalue($(this),price,stock),_self.set_chahevalue(stock,price,$(this).parent().find("font").html())}),$('input[name="supplierCalendar"]').val(JSON.stringify(_self.supplierCalendar))}else $public.dialog.msg("请选择要设置的日期","error")}),
//清除价格和库存
$(".clearvl").on("click",function(){var $dtbx=$(".day .choiced .dtbx");$dtbx.length>0?($dtbx.filter(function(){$(this).find(".tipvl").remove(),_self.del_chahevalue($(this).parent().find("font").html())}),$(document).trigger("click"),$(".price,.stock").val(""),$('input[name="supplierCalendar"]').val(JSON.stringify(_self.supplierCalendar))):$public.dialog.msg("请选择要清除信息的日期","error")}),$(".setvalue").on("click",function(ev){$public.stopBubble(ev)}),$(".tdyears .prev").on("click",function(ev){var cur_years=parseInt($("#SY").text());$("#SY").text(cur_years-1),_self.changeCld(),$public.stopBubble(ev)}),$(".tdyears .next").on("click",function(ev){var cur_years=parseInt($("#SY").text());$("#SY").text(cur_years+1),_self.changeCld(),$public.stopBubble(ev)}),$(".tdmonth li").on("click",function(ev){$(".tdmonth li").removeClass("on"),$(this).addClass("on"),_self.changeCld(),$public.stopBubble(ev)}),$(".tdmonth li").on("click",function(ev){$(".tdmonth li").removeClass("on"),$(this).addClass("on"),_self.changeCld(),$public.stopBubble(ev)}),window.document.onclick=function(){$(".day td").filter(function(){$(this).attr("class")&&($(this).css("background","#fff").attr("class","").find("font").css("color",this.color_temp),$(this).find("label").css("color","#666"))}),_self.isCtrl||(_self.empty_ckbox={})},window.document.onkeydown=function(evt){evt=evt||window.event||arguments.callee.caller.arguments[0],17==evt.keyCode&&(_self.isCtrl=!0)},window.document.onkeyup=function(evt){evt=evt||window.event||arguments.callee.caller.arguments[0],17==evt.keyCode&&(_self.isCtrl=!1)},_self.initial()},
//返回农历y年的总天数
lYearDays:function(y){var i,sum=348;for(i=32768;i>8;i>>=1)sum+=this.lunarInfo[y-1900]&i?1:0;return sum+this.leapDays(y)},
//返回农历y年闰月的天数
leapDays:function(y){return this.leapMonth(y)?65536&this.lunarInfo[y-1900]?30:29:0},
//判断y年的农历中那个月是闰月,不是闰月返回0
leapMonth:function(y){return 15&this.lunarInfo[y-1900]},
//返回农历y年m月的总天数
monthDays:function(y,m){return this.lunarInfo[y-1900]&65536>>m?30:29},
//返回公历y年m+1月的天数
solarDays:function(y,m){return 1==m?y%4==0&&y%100!=0||y%400==0?29:28:this.solarMonth[m]},
//记录公历和农历某天的日期
calElement:function(sYear,sMonth,sDay,week){return{isToday:!1,sYear:sYear,sMonth:sMonth,sDay:sDay,week:week}},calendar:function(y,m){this.fat=this.mat=0;var sDObj,lD=1,lX=0,obj={};sDObj=new Date(y,m,1),//当月第一天的日期
obj.length=this.solarDays(y,m),//公历当月天数
obj.firstWeek=sDObj.getDay(),//公历当月1日星期几
m+1==5&&(this.fat=sDObj.getDay()),m+1==6&&(this.mat=sDObj.getDay());for(var i=0;i<obj.length;i++)lD>lX&&(sDObj=new Date(y,m,i+1)),obj[i]=this.calElement(y,m+1,i+1,this.nStr1[(i+obj.firstWeek)%7]),(i+obj.firstWeek)%7==0&&(obj[i].color="red");//今日
return y==this.tY&&m==this.tM&&(obj[this.tD-1].isToday=!0),obj},drawCld:function(SY,SM){var TF=!0,_prent_self=this,p1=p2="",i,sD,s,size;for(_prent_self.cld=_prent_self.calendar(SY,SM),i=0;i<42;i++)sObj=eval("SD"+i),sObj.className="",sD=i-_prent_self.cld.firstWeek,sD>-1&&sD<_prent_self.cld.length?(//日期内
sObj.innerHTML=sD+1,_prent_self.cld[sD].isToday?sObj.style.color="#ffaf00":sObj.style.color="#666",_prent_self.checkRangeDay(new Date(SY,SM,sD+1),_prent_self.rangedays)?$(sObj).closest("td").css({background:"#fff",cursor:"pointer"}).off().removeClass().on("click",function(ev){var _self=this;_prent_self.isCtrl||$(".day td").filter(function(){$(this).attr("class")&&($(this).css("background","#fff").attr("class","").find("font").css("color",this.color_temp),$(this).find("label").css("color","#666"))}),$(_self).attr("class")?($(_self).css("background","#fff").attr("class","").find("font").css("color",_self.color_temp),$(_self).find("label").css("color","#666")):(_self.color_temp=$(_self).find("font")[0].style.color,$(_self).css("background","#ed6c44").attr("class","choiced").find("font,label").css("color","#fff"),$(".price").val($(_self).find(".price_").text()),$(".stock").val($(_self).find(".stock_").text())),_prent_self.isCtrl&&$(".price,.stock").val(""),$public.stopBubble(ev)}):$(sObj).closest("td").css({background:"#f5f5f5",cursor:"initial"}).off().removeClass()):(//非日期
sObj.innerHTML="",$(sObj).closest("td").css({background:"#f5f5f5",cursor:"initial"}).off());""==$(".datepicker tr.last td:eq(0) font").text()?$(".datepicker tr.last").hide():$(".datepicker tr.last").show(),
//渲染已设置的日期
this.dateRender(this.supplierCalendar)},
//记录选中点
recordck:function(obj,type){var cur_smp=new Date($("#SY").text(),$(".tdmonth li.on").index(),obj.find("font").html()).valueOf();this.isCtrl||(this.empty_ckbox={}),"add"!=type||this.empty_ckbox[cur_smp]?"del"==type&&this.empty_ckbox[cur_smp]&&delete this.empty_ckbox[cur_smp]:this.empty_ckbox[cur_smp]=!0},
//渲染已设置的日期
dateRender:function(supplierCalendar){var ls=this.supplierCalendar.bizSkuInfo,days=$(".dtbx font"),_self=this;$(".tipvl").remove();for(var i=0;i<ls.length;i++)days.filter(function(){if(""!=this.innerHTML){var cur_smp=new Date($("#SY").text(),$(".tdmonth li.on").index(),this.innerHTML).valueOf();if(cur_smp==ls[i].vTxt&&"del"!=ls[i].state){var cur_td=$(this).closest("td")[0];_self.set_tdvalue($(cur_td).find(".dtbx"),ls[i].price,ls[i].stock_num),_self.checkRangeDay(new Date($("#SY").text(),$(".tdmonth li.on").index(),parseInt(this.innerHTML)+1),_self.rangedays)?(cur_td.color_temp||(cur_td.color_temp=$(cur_td).find("font")[0].style.color),$(cur_td).css("background","#ed6c44").attr("class","choiced").find("font,label").css("color","#fff")):(console.log(this.innerHTML),console.log($(cur_td).find(".tipvl").html()),$(cur_td).find("font,label").css("color","rgb(102, 102, 102)"))}}})},
//价格和库存写入缓存
set_chahevalue:function(stock,price,day){for(var cur_time=new Date($("#SY").text(),$(".tdmonth li.on").index(),day).getTime()+"",ls=this.supplierCalendar.bizSkuInfo,i=0;i<ls.length;i++)if(cur_time==ls[i].vTxt&&"del"!=ls[i].state)return 0!=ls[i].sku_id&&(ls[i].state="update"),ls[i].stock_num=stock,ls[i].price=price,void console.log(JSON.stringify(this.supplierCalendar.bizSkuInfo)+"   ---------set_chahevalue--update------");ls.push({sku_id:0,state:"add",stock_num:stock,price:price,vTxt:cur_time}),console.log(JSON.stringify(this.supplierCalendar.bizSkuInfo)+"   --------set_chahevalue--add------")},
//从缓存删除价格和库存
del_chahevalue:function(day){for(var cur_time=new Date($("#SY").text(),$(".tdmonth li.on").index(),day).getTime()+"",ls=this.supplierCalendar.bizSkuInfo,i=0;i<ls.length;i++)cur_time==ls[i].vTxt&&("update"==ls[i].state||""==ls[i].state?ls[i].state="del":"add"==ls[i].state&&ls.remove(i));console.log(JSON.stringify(this.supplierCalendar.bizSkuInfo)+"   -------del_chahevalue----------")},
//设置日期的价格和库存
set_tdvalue:function(obj,price,stock){0==obj.find(".tipvl").length?obj.append('<div class="tipvl"><label>￥：</label><label class="price_">'+price+'</label><br><label>库存：</label><label class="stock_">'+stock+"</label></div>"):(obj.find(".price_").text(price),obj.find(".stock_").text(stock)),obj.find("label").css("color","#fff")},
//监测日期是否在规定范围内
//"v" 要检测的日期
//"frontRangeDay" 向前延伸的天数
//"behindRangeDay" 向后延伸的天数
checkRangeDay:function(v,frontRangeDay,behindRangeDay){var cur_time=new Date,behindRangeDay=behindRangeDay?behindRangeDay:0,frontRangeDay=frontRangeDay?frontRangeDay:0,days=Math.ceil((v-cur_time)/1e3/60/60/24);return-behindRangeDay<=days&&days<=frontRangeDay-1},
//在下拉列表中选择年月时,调用自定义函数drawCld(),显示公历和农历的相关信息
changeCld:function(){var y,m;y=$("#SY").text(),m=$(".tdmonth li.on").index(),this.drawCld(y,m)},
//打开页时,在下拉列表中显示当前年月,并调用自定义函数drawCld(),显示公历和农历的相关信息
initial:function(){var gNum,str="",slcvalue=$('input[name="supplierCalendar"]').val();for(i=0;i<6;i++){for(str+='<tr class="day '+(5==i?"last":"")+'">',j=0;j<7;j++)gNum=7*i+j,str+='<td id="GD'+gNum+'"><div class="dtbx"><font id="SD'+gNum+'"',0==j&&(str+=' style="color:red"'),6==j&&(str+=' style="color:#000080"'),str+="> </font></div></td>";str+="</tr>"}$(".datepicker table").append(str),$("#SY").text(this.tY),$(".tdmonth li").removeClass("on"),$(".tdmonth").find("li:eq("+this.tM+")").addClass("on"),slcvalue?this.supplierCalendar=JSON.parse(slcvalue):$('input[name="supplierCalendar"]').val(JSON.stringify(this.supplierCalendar)),this.drawCld(this.tY,this.tM)}},module.exports=new $datepicker});
/*! pc_jx 最后修改于： 2016-07-28 */