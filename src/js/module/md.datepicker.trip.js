/*! PC_JX - v1.0.0 - 2016-11-29 */
define(function(require,exports,module){$public=require("public"),$datepicker=function(a){this.solarMonth=new Array(31,28,31,30,31,30,31,31,30,31,30,31),this.nStr1=new Array("日","一","二","三","四","五","六","七","八","九","十"),this.rangedays=90,this.empty_ckbox={},this.fat=this.mat=9,this.cld=null,this.isCtrl=!1,this.isShift=!1,this.lastCtrlSelectDay=0,this.Today=new Date,this.tY=this.Today.getFullYear(),this.tM=this.Today.getMonth(),this.tD=this.Today.getDate(),this.months=[],this.lunarInfo=new Array(19416,19168,42352,21717,53856,55632,91476,22176,39632,21970,19168,42422,42192,53840,119381,46400,54944,44450,38320,84343,18800,42160,46261,27216,27968,109396,11104,38256,21234,18800,25958,54432,59984,28309,23248,11104,100067,37600,116951,51536,54432,120998,46416,22176,107956,9680,37584,53938,43344,46423,27808,46416,86869,19872,42448,83315,21200,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46496,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19415,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448),this.supplierCalendar={id:"1",name:"套餐",PId:22,PType:5,PTxt:"套餐",months:[]},this.init.apply(this,arguments)},$datepicker.prototype={init:function(){var a=this;if(months=this.supplierCalendar&&this.supplierCalendar.months,$(".rds").val()&&(a.rangedays=$(".rds").val()),$("#priceInfoJson").val()){var b=JSON.parse($("#priceInfoJson").val());$.each(b.tcs,function(b,c){$.each(c.months,function(b,c){$.each(c.days,function(b,c){var d=$public.dateFormat(new Date(c.time),"yyyy-MM-dd").split("-")[1];d=d<10?d.substring(1):d,a.months.push(Number(d))})})}),a.months=a.unique(a.months)}$(".setvl").on("click",function(){var b=$(".day .choiced .dtbx"),c=$(".day .choiced .dtbx .tipvl"),d=!0,e=0;if(c.remove(),b.length>0){if($(".datepicker .price").each(function(c){var f=!0,g=$(this),h=$(this).parent().next().find(".stock"),i=$(this).parent().prev().attr("data-pTxt")||"";if(f&&g.val()&&!/^\d{1,6}(\.\d{1,2})?$|^[1-9]\d{0,5}$/.test(g.val())||h.val()&&!g.val())return $public.dialog.msg("“价格”为数字,最大6位整数,能带两位小数","error"),g.focus(),d=!1,!1;if(g.val()&&h.length&&!/^[1-9]\d{0,5}$/.test(h.val()))return $public.dialog.msg("“库存”为数字,最大6位整数","error"),h.focus(),d=!1,!1;if(f=!1,g.val()){if(e++,"单房差"==i&&!$(".datepicker .price").eq(0).val()&&"单房差"==i&&!$(".datepicker .price").eq(1).val())return void $public.dialog.msg("请输入成人或者儿童的价格和库存","error");b.filter(function(){a.set_tdvalue($(this),g.val(),h.val(),i)})}}),!d)return!1;if(d&&0==e)return void $public.dialog.msg("请输入成人或者儿童的价格和库存","error");a.setTcData()}else $public.dialog.msg("请选择要设置的日期","error")}),$(".clearvl").on("click",function(){var b=$(".day .choiced .dtbx");b.length>0?(b.filter(function(){$(this).find(".tipvl").remove(),$(this).closest("td").removeAttr("data-sku-id"),$(".add-tc .btn-outline").each(function(){$(this).hasClass("active")&&a.setTcData()})}),$(document).trigger("click"),$(".price,.stock").val("")):$public.dialog.msg("请选择要清除信息的日期","error")}),$(".setvalue").on("click",function(a){$public.stopBubble(a)}),$(".tdyears .prev").on("click",function(b){var c=parseInt($("#SY").text());$("#SY").text(c-1),a.changeCld(),$public.stopBubble(b)}),$(".tdyears .next").on("click",function(b){var c=parseInt($("#SY").text());$("#SY").text(c+1),a.changeCld(),$public.stopBubble(b)}),$(".tdmonth li").on("click",function(b){$(".tdmonth li").removeClass("on"),$(this).addClass("on"),$(".add-tc .btn-outline").each(function(){if($(this).hasClass("active")){var b=$(this).attr("data-tc");a.supplierCalendar="string"==typeof b?JSON.parse(b):a.supplierCalendar}}),a.changeCld(),$public.stopBubble(b)}),$(".tdmonth li").on("click",function(b){$(".tdmonth li").removeClass("on"),$(".tdweek input[type='checkbox']").attr("checked",!1),$(this).addClass("on"),this.lastCtrlSelectDay=0,a.changeCld(),$public.stopBubble(b)}),$(".tdweek").on("click","td:has(input[type='checkbox'])",function(){var a=event.target.tagName.toLowerCase();if("td"==a){var b=event.target.children[0];b.checked=!b.checked}else if("input"==a)var b=event.target;var c=b.checked,d=$(b).attr("week");c?$(".day td.in-range[week='"+d+"']").addClass("choiced"):$(".day td.in-range[week='"+d+"']").removeClass("choiced")}),window.document.onclick=function(){},window.document.onkeydown=function(b){b=b||window.event||arguments.callee.caller.arguments[0],17==b.keyCode&&(a.isCtrl=!0),16==b.keyCode&&(a.isShift=!0)},window.document.onkeyup=function(b){b=b||window.event||arguments.callee.caller.arguments[0],17==b.keyCode&&(a.isCtrl=!1),16==b.keyCode&&(a.isShift=!1)},window.document.onselectstart=function(){},a.initial()},lYearDays:function(a){var b,c=348;for(b=32768;b>8;b>>=1)c+=this.lunarInfo[a-1900]&b?1:0;return c+this.leapDays(a)},leapDays:function(a){return this.leapMonth(a)?65536&this.lunarInfo[a-1900]?30:29:0},leapMonth:function(a){return 15&this.lunarInfo[a-1900]},monthDays:function(a,b){return this.lunarInfo[a-1900]&65536>>b?30:29},solarDays:function(a,b){return 1==b?a%4==0&&a%100!=0||a%400==0?29:28:this.solarMonth[b]},calElement:function(a,b,c,d){return{isToday:!1,sYear:a,sMonth:b,sDay:c,week:d}},calendar:function(a,b){this.fat=this.mat=0;var c,d=1,e=0,f={};c=new Date(a,b,1),f.length=this.solarDays(a,b),f.firstWeek=c.getDay(),b+1==5&&(this.fat=c.getDay()),b+1==6&&(this.mat=c.getDay());for(var g=0;g<f.length;g++)d>e&&(c=new Date(a,b,g+1)),f[g]=this.calElement(a,b+1,g+1,this.nStr1[(g+f.firstWeek)%7]),(g+f.firstWeek)%7==0&&(f[g].color="red");return a==this.tY&&b==this.tM&&(f[this.tD-1].isToday=!0),f},select:function(a){$(".day .choiced").removeClass("choiced"),a.addClass("choiced"),$(".price,.stock").val(""),a.find(".price_").each(function(a){var b=$(".price").eq(a),c=$(this).attr("data-ptxt");"单房差"==c?$(".price").eq(2).val($(this).text()).attr("data-sku-id",$(this).attr("data-sku-id")):b.val($(this).text()).attr("data-sku-id",$(this).attr("data-sku-id"))}),a.find(".stock_").each(function(a){var b=$(".stock").eq(a),c=$(this).attr("data-ptxt");"单房差"==c?$(".stock_").eq(2).val($(this).text()).attr("data-sku-id",$(this).attr("data-sku-id")):b.val($(this).text()).attr("data-sku-id",$(this).attr("data-sku-id"))}),this.lastCtrlSelectDay=0},unique:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];b.indexOf(d)===-1&&b.push(d)}return b},ctrlSelect:function(a){a.hasClass("choiced")?a.removeClass("choiced"):(a.addClass("choiced"),1==$(".day .choiced").length?($(".price").val(a.find(".price_").text()),$(".stock").val(a.find(".stock_").text())):$(".price,.stock").val(""),this.lastCtrlSelectDay=parseInt(a.attr("day")),console.log("lastCtrlSelectDay:"+this.lastCtrlSelectDay))},shiftSelect:function(a){var b,c,d=$(".day .choiced").length,e=parseInt(a.attr("day"));if(0==d)a.addClass("choiced"),$(".price").val(a.find(".price_").text()),$(".stock").val(a.find(".stock_").text()),this.firstShiftSelectDay=e;else{if(c=e,b=1==d?parseInt($(".day .choiced").attr("day")):parseInt($(".day .choiced").last().attr("day")),0!=this.lastCtrlSelectDay&&(b=this.lastCtrlSelectDay),console.log("startDay:"+b),console.log("endDay:"+c),c<=b)return;for(var f=b;f<=c;f++)$(".day td[day='"+f+"']").addClass("choiced");this.lastCtrlSelectDay=0,$(".price,.stock").val("")}},drawCld:function(a,b){var c,d,e=this;p2="";for(e.cld=e.calendar(a,b),c=0;c<42;c++){var f=document.getElementById("SD"+c),g=$(f).closest("td");if(g.removeClass().attr("day","").attr("week",""),d=c-e.cld.firstWeek,d>-1&&d<e.cld.length){f.innerHTML=d+1,e.cld[d].isToday&&g.addClass("today");var h=new Date(a,b,d+1);g.attr("day",d+1).attr("week",h.getDay()),e.checkRangeDay(h,e.rangedays)?g.addClass("in-range").off().on("click",function(a){var b=$(this);b.hasClass("out-range")||(e.isCtrl?e.ctrlSelect(b):e.isShift?e.shiftSelect(b):e.select(b),$(".tdweek input[type='checkbox']").each(function(){var a=$(this).attr("week"),b=$(".day td.in-range[week='"+a+"']").length,c=$(".day td.choiced[week='"+a+"']").length;0!=b&&(this.checked=b==c)}),$public.stopBubble(a))}):g.addClass("out-range").off()}else f.innerHTML="",g.addClass("out-range").off()}""==$(".datepicker tr.last td:eq(0) font").text()?$(".datepicker tr.last").hide():$(".datepicker tr.last").show(),$(".datepicker td").each(function(){$(this).removeAttr("data-sku-id")}),this.dateRender(this.supplierCalendar)},recordck:function(a,b){var c=new Date($("#SY").text(),$(".tdmonth li.on").index(),a.find("font").html()).valueOf();this.isCtrl||(this.empty_ckbox={}),"add"!=b||this.empty_ckbox[c]?"del"==b&&this.empty_ckbox[c]&&delete this.empty_ckbox[c]:this.empty_ckbox[c]=!0},dateRender:function(a){this.supplierCalendar="string"==typeof a?JSON.parse(a):this.supplierCalendar;var b=this,c=this.supplierCalendar&&this.supplierCalendar.months,d=$(".dtbx font");$(".tipvl").remove(),c&&($.each(c,function(a,c){$.each(c.days,function(a,c){d.filter(function(){if(""!=this.innerHTML){var a=new Date($("#SY").text(),$(".tdmonth li.on").index(),this.innerHTML).valueOf();if(a==c.time){var d=$(this).closest("td")[0];$.each(c.blocks,function(a,c){b.set_tdvalue($(d).find(".dtbx"),c.price/100,c.stock,c.name,c.skuId)}),b.checkRangeDay(new Date($("#SY").text(),$(".tdmonth li.on").index(),this.innerHTML),b.rangedays)?$(d).addClass("choiced"):(console.log(this.innerHTML),console.log($(d).find(".tipvl").html()))}}})})}),$(".tdweek input[type='checkbox']").each(function(){var a=$(this).attr("week"),b=$(".day td.in-range[week='"+a+"']").length,c=$(".day td.choiced[week='"+a+"']").length;0!=b&&(this.checked=b==c)}))},set_tdvalue:function(a,b,c,d,e){var f="",g=[];0==a.find(".tipvl").length?e?a.append('<div class="tipvl"><div class="item"><label>'+d+'￥</label><label class="price_" data-sku-id="'+e+'" data-pTxt="'+d+'">'+b+'</label><br><label>库</label><label class="stock_" data-sku-id="'+e+'" data-pTxt="'+d+'">'+c+"</label></div></div>"):a.append('<div class="tipvl"><div class="item"><label>'+d+'￥</label><label class="price_" data-pTxt="'+d+'">'+b+'</label><br><label>库</label><label class="stock_">'+c+"</label></div></div>"):(e?f+='<div class="item"><label>'+d+'￥</label><label class="price_" data-sku-id="'+e+'" data-pTxt="'+d+'">'+b+'</label><br><label>库</label><label class="stock_" data-sku-id="'+e+'" data-pTxt="'+d+'">'+c+"</label></div>":(f+='<div class="item"><label>'+d+'￥</label><label class="price_" data-pTxt="'+d+'">'+b+"</label>",c&&(f+='<br><label>库</label><label class="stock_" data-pTxt="'+d+'">'+c+"</label></div>")),a.find(".tipvl").append(f)),e&&(a.find(".price_").each(function(){var a=$(this).attr("data-ptxt"),b=$(this).attr("data-sku-id");g.push({pTxt:a,skuId:b})}),a.closest("td").attr("data-sku-id",JSON.stringify(g))),a.find(".price_").length>=3&&a.find(".price_").each(function(){"单房差"==$(this).attr("data-ptxt")&&a.find(".tipvl").append($(this).closest(".item"))})},update_value:function(a){var b=this.supplierCalendar.months;return $(".day .choiced .dtbx").each(function(c,d){new Date($("#SY").text(),$(".tdmonth li.on").index(),$(d).find("font").text()).getTime()+"";$.each(b,function(b,c){$(".tdmonth li.on").index()+1==new Date(c.date).getMonth()+1&&(c.days=a)})}),!1},checkRangeDay:function(a,b,c){var d=new Date,c=c?c:0,b=b?b:0,e=Math.ceil((a-d)/1e3/60/60/24);return-c<=e&&e<=b-1},changeCld:function(){var a,b;a=$("#SY").text(),b=$(".tdmonth li.on").index(),this.drawCld(a,b)},initial:function(){var a,b="";for(i=0;i<6;i++){for(b+='<tr class="day '+(5==i?"last":"")+'">',j=0;j<7;j++)a=7*i+j,b+='<td id="GD'+a+'"><div class="dtbx"><font id="SD'+a+'"',0==j&&(b+=' style="color:red"'),6==j&&(b+=' style="color:#000080"'),b+="> </font></div></td>";b+="</tr>"}$(".datepicker table").append(b),$("#SY").text(this.tY),$(".tdmonth li").removeClass("on"),$(".tdmonth").find("li:eq("+this.tM+")").addClass("on"),this.drawCld(this.tY,this.tM)},setTcData:function(){var a=this,b=[];$(".day .dtbx").each(function(){var a=($(this),""),c=[],d=new Date($("#SY").text(),$(".tdmonth li.on").index(),$(this).find("font").text()).getTime()+"";$(this).find(".tipvl").length&&($(this).find(".item").each(function(a,b){var d=$(b).find(".price_"),e=$(b).find(".stock_"),f=100*d.text(),g=e.text(),h=d.attr("data-ptxt"),i=$(b).closest("td").attr("data-sku-id")&&JSON.parse($(b).closest("td").attr("data-sku-id")),j="",k="",l="",m="";switch(g=!f&&0!=f||g?g:999,i&&$.each(i,function(a,b){b.pTxt.indexOf(h)>-1&&(j=Number(b.skuId))}),2==h.length&&(h=h.substring(0,1)),h){case"成":k=1,l=2,m="成";break;case"儿":k=145,l=1,m="儿";break;case"单房差":k=4,l=3,m="单房差"}c.push({skuId:j||0,id:k,type:l,name:m,PId:21,PType:4,pTxt:"人员类型",price:f,stock:g})}),a={PId:20,PType:3,PTxt:"出发日期",time:d,blocks:c},b.push(a))}),$.inArray($(".tdmonth li.on").index()+1,a.months)==-1?(month={date:new Date($("#SY").text(),$(".tdmonth li.on").index()).getTime(),days:b},a.supplierCalendar.months.push(month),a.months.push($(".tdmonth li.on").index()+1)):(console.log(b),a.update_value(b)),$(".add-tc .btn-outline").each(function(){var b=$(this);b.hasClass("active")&&(a.supplierCalendar.id=-$(this).attr("data-id"),a.supplierCalendar.name=b.text(),a.supplierCalendar.PId=22,a.supplierCalendar.PType=5,console.log(JSON.stringify(a.supplierCalendar)),a.supplierCalendar&&b.attr("data-tc",JSON.stringify(a.supplierCalendar)),b.html($(".tc-name").val()+'<i class="icon-close"></i>'))})}},module.exports=new $datepicker});
/*! PC_JX xiongzhaoling 最后修改于： 2016-11-29 */